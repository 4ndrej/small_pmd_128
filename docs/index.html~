<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML><HEAD><TITLE>Urob si sám PMD-85-1</TITLE>
<META content="text/html; charset=windows-1250" http-equiv=Content-Type>
</HEAD>

<BODY>
	
<B>Autor:</B> Ing. Peter Chrenko, Janka Matušku 2178/21, 955 01 Topo¾èany, 
Slovensko <BR><B>Kontakt:</B> <A href="mailto:peto@kmit.sk">peto@kmit.sk</A>, <A 
href="http://www.kmit.sk/~peto">http://www.kmit.sk/~peto</A>, ICQ: 
177600338<BR><BR>
<H1>Urob si sám PMD-85</H1>
<P>PMD-85 bol slávny osembitovı mikropoèítaè hojne pouívanı v
Èeskoslovensku v rokoch 1984-1994. Rozšírenı bol hlavne cez krúky tedajšieho ZVAZARMu, domov pionierov a mládee
i celkovou dostupnosou v školstve. 

<br>
Cie¾om tejto konštrukcie je umoni nadšencom postavi si vlastnı klon PMDèka. To znamená vytvorenie zariadenia z ktorého po pripojení televízora, klávesnice a zdroja sa prenesiete do rokov 80tych a zahráte si napríklad ob¾úbeného MANIC MINERa alebo skúsite nieèo naprogramova v starom programovacom jazyku BASIC-G.   
<br><br>
Toto všetko vrátane cca 120 KB pôvodnıch hier a programov sa podarilo postupnımi iteráciami napokon vtesnat iba do dvoch integrovanıch obvodov a to: ATmega128-16 a IO 64 KB pamäte RAM. Zobrazovanie obrazu na televízore (TV), generovanie zvuku, obsluha klávesnice ako aj vlastná emulácia chovania procesora Intel 8080, ktorı bol srdcom pôvodného PMD-85, je realizovaná èisto softvérovo. 


Samozrejme vdy je rozdiel medzi kópiou a originálom a inak to nebude ani v našom prípade. Niektoré nepodstatné vlastnosti pôvodného PMDèka boli zanedbané alebo vynechané, nieèo bolo implementované zjednodušene. Z poh¾adu softvéru, pôvodnıch programov na PMDèku, sa dosiahla kompatibilita takmer 100%, beia všetky známe programy vrátane vıbornej hry HLÍPY od Karla Šuhajdu. Generovanie èiernobieleho TV obrazu vrátane atribútov blikanie a jas je ve¾mi vıborné, náhrada magnetofónu pamäou FLASH na èítanie taktie vıborná, nehovoriac o nieko¾konásobnom zrıchlení nahrávania programov. Pôvodná klávesnica PMDèka ako jediné vstavané vstupné zariadenie je nahradená lacnou externou PS/2 klávesnicou. Najväèšie momentálne nedostatky v konštrukcií resp. obslunom softvéri sú pri generovaní zvukového vıstupu. 


<br><br>





  



</P>

<P><B>Pôvodné PMD-85</B> bol mikropoèítaè postavenı z v tej dobe populárnej procerosovej rodiny Intel 8080 (MHB 8080). Jednalo sa o obvody 8080 - procesor, 8228 - radiè zbernice, 8224 - hodinovı generátor, 3x8255 - paralelné rozhranie, 8251 - sériové rozhranie apod.  Typickım pre systémy z 80 rokov bolo pouitie aj obvodov s malou hustotou integrácie - TTL logiky. U PMD bol technológiou TTL obvodov zostavenı kompletnı videoprocesor, starajúci sa o cyklické zobrazovanie videopamäte na pripojenom televízore. </p>
<p>
PMD sa skladalo z nasledovnıch hardvérovıch modulov:

<UL>
	<li>procesorovı modul</li>	
	<LI>videoprocesor </li>
	<LI>modul interfejsov </li>
	<LI>klávesnica</li>
	<LI>ROM modul (BASIC-G) </LI>
</UL>
</p>



<P>Nebudeme rozobera pôvodné obvodové riešenie PMDèka, problematike  sú venované monografie dostupné v kniniciach. Uvedieme preto popis realizácie nášho klonu PMD-85/1. V krátkosti treba doda e verzie PMD-85/1, PMD-85/2, PMD-85/2A, PMD-85/3 boli navzájom èiastoène nekompatibilné a tie väèšina softvéru vznikla práve pre model PMD-85/1. 
<br/>
Treba tie doda e PMD-85/1 komunikovalo s magnetofónom prostredníctvom USART obvodu, èo znamená podstatne jednoduhší model komunikácie s magnetofónom ktorı je podstatne jednoduhší na emuláciu ako emulova serializáciu dátového toku modulovaného 1200 Hz u vyšších modeloch PMD. Je však nesporné e kvalita BASIC-u i firmware postupne u jednotlivıch modelov stúpala. 
</P>

<p>
Cie¾om konštrukcie je teda vyhotovenie zariadenia, z ktorého sa po pripojení zdroja (AC/DC adaptéra z vıchodnej Ázie), PS/2 klávesnice a klasického televízora so vstupom kompozitného videa/SCART stane plnohodnotné PMD-85/1. Navyše s virtuálnou magnetofónovou kazetou 120 KB hier medzi inımi MANIC MINER, BOULDER DASH, PENETRATOR, DUCH&amp;PAMPÚCH, HLÍPA, PAMPUCH, FLAPPY, WURMI èi SABOTER. 

</p>



<P><div><img src="schema.png" alt="Obr. 1"/><br/>Obr. è.1 </div><br/>

Na obrázku 1 je znázornená obvodová schéma. Komunikácia s uívate¾om sa realizuje prostredníctvom externej klávesnice a televízneho prijímaèa. 
Jeden z k¾úèovıch prvkov konštrukcie je zvládnutie generovania úplného televízneho signálu v rozlíšení 288x256 pixelov, prièom kadá šestica pixelov má dvojbitovı grafickı atribút, presne tak ako pôvodné PMD-85/1. 
</P>


<H2>VIDEO D/A prevodník</H2>
<p>
Generovanie kompozitného videa signálu <b>COMPOSITE_VIDEO</b> realizuje asymetrickı D/A prevodník realizovanı odporovou sieou R1, R3 a R4, ktorá mixuje TTL videodáta VIDEO_DATA a 
synchronizaènú zmes SYNC do štandardného videosignálu cca 1 V<sub>šš</sub>. Signál COMPOSITE_VIDEO je vyvedenı na CINCH konektor VO0. Vopred upozoròujem e na jednovrstvojej doske plošného spoja <b>je nutné prepoji prepojkou PAD1 s COMPOSITE_VIDEO</b>. Obvod jasového atribútu, zloeného z diód D1, D2 a odporu R2 realizuje zvıšenie jasu zobrazovaného pixelu v prípade rovnakej hodnoty signálov BRIGHT=1 a VIDEO_DATA=1.
<br/><br/>
<div>
<table border="1" align="center">
	<tr>
		<th>VIDEO_DATA</th><th>BRIGHT</th><th>SYNC</th><th>COMPOSITE_VIDEO [V]</th>
	</tr>
        <tr>
		<td>L</td><td>X</td><td>L</td><td>0 (synchro úroveò)</td>	
	</tr>
        <tr>
		<td>L</td><td>X</td><td>H</td><td>0.7 (úroveò èiernej)</td>	
	</tr>
        <tr>
		<td>H</td><td>L</td><td>H</td><td>1.0 (50% jas)</td>	
	</tr>
        <tr>
		<td>H</td><td>H</td><td>H</td><td>1.4 (100% jas = biela)</td>	
	</tr>
</table>
<br/>
Tabu¾ka è.1.
</div>
<br/><br/>
Napäové úrovne COMPOSITE_VIDEO sú ve¾ké pribline pod¾a tabu¾ky è.1, kde symboly logickıch úrovní H, L a X majú obvyklı vıznam. Z tabu¾ky je zrejmé e úrovne vıstupného kompozitného signálu nie sú exaktne pod¾a odporúèaní TV normy, ale neuberá to na funkènosti zapojenia èi ostrosti generovaného obrazu.  
</p>

<h2>PAMÄOVİ PODSYSTÉM</h2>
<p>
K procesoru ATmega128 (IC1) je pripojená 128 (alebo 64) KB SRAM v púzdre SOJ IC2, z ktorej sa momentálne vyuíva iba prvıch 64 KB. 

Pamä je adresovaná 17 bitovou adresnou zbernicou, vytvorenou z portov monolitického mikropoèítaèa ATmega128 tak, aby procesor mohol v priebehu 2 taktov vysla 16 bitovú èas adresy inštrukciou OUT. 16-tym adresnım bitom sa prepína medzi dvoma 64 KB bankami pamäte a bene sa nezúèastòuje adresnej aritmetiky. Pod¾a schémy na obrázku è.1 vidíme e adresné bity 0. a 15. sú porozhadzované po portoch PB a PD na prvı poh¾ad nezmyselne, ale tak aby na jednovrstvovom plošnom spoji nevzniklo kríenie vodièov. Dátová obojsmerná zbernica je riešená pouitím celého 8 bitového portu PC. Signály èítania /RD a zápisu /WR sú generované 2 bitmi portu PA. 

Pamä je trvalo selektovaná signálmi /E1.E2 = 1.  
</p>
<p>

Vnútornú pamä ATmega128 typu FLASH vyuívame jednak na uloenie softvéru simulujúcim správanie PMDèka (cca 8 KB) a programov pre PMD-85 (cca 120 KB) simulujúcou magnetofón a ROM modul s programom BASIC-G/V1. Táto èas programového vybavenia je uloená v kompresovanom RLE tvare. Vnútorná 4 KB EEPROM procesora ATmega128 je taktie vyuitá do posledného bajtu na uloenie 4 KB ROM firmware PMDèka.   

</p><p>

Takéto riešenie pripojenia externej pamäte RAM umoòuje zvıši priepustnos pamäového podsystému oproti štandardne pouívanemu zapojeniu z manuálu s pouitím záchytného registra. ATmega128 bohuial nepodporuje lineárny pamäovı priestor externej RAM plnıch 64 KB, nako¾ko vnútorná RAM a registre sú adresované tımi istımi inštrukciami ako externá pamä. Na emuláciu správania PMDèka je potrebnıch lineárnych 64 KB priestoru RAM, ktoré sú vyuívané nasledovne:  

<table border="1" align="center">
	<tr><td>0x0000 &divide; 0x7FFF</td><td> 32 KB RAM 	</td></tr>
	<tr><td>0x8000 &divide; 0x8FFF</td><td> 4 KB ROM firmware</td></tr>
	<tr><td>0x9000 &divide; 0xBFFF</td><td> 12 KB neobsadené </td></tr>
	<tr><td>0xC000 &divide; 0xFFFF</td><td> 16 KB VIDEORAM </td></tr>
</table>

</p>

<h2>VIDEOPROCESOR</h2>
<p>
Videoprocesor periodicky èíta obsah videopamäte a zaisuje generovanie TV signálu cez VIDEO D/A prevodník. 
Táto èinnos zaberá pouitému mikroprocesoru ATmega128 pribline 3/4 strojového èasu. Zvyšná 1/4 vıkonu postaèuje na simuláciu chovania procesora 8080, pouitom v originálnom PMD-85. Pozrime sa podrobnejšie ako a z èoho sa generuje videosignál. 
</p>
<p>
Videopamä je 16 KB ve¾ká pamä RAM organizovaná do 256 riadkov po 64 bajtoch. Jeden riadok obsahuje 48 "vidite¾nıch" bajtov a 16 bajtov ktoré sú zatemnené. Jeden bajt je pod¾a nasledovnej tabu¾ky organizovanı tak e nesie informáciu o 6 pixeloch a k nim prislúchajúci 2 bitovı atribút:
<br/><br/>
<table border="1" align="center">
	<tr><th>D7</th><th>D6</th><th>D5</th><th>D4</th><th>D3</th><th>D2</th><th>D1</th><th>D0</th></tr>
	<tr><td>BLINK</td><td>BRIGHTNESS</td><td>P0</td><td>P1</td><td>P2</td><td>P3</td><td>P4</td><td>P5</td></tr>
</table>
<br/>
Zaujímavé je reverzné poradie pixelov P0 a P5, t.j. pixel v¾avo má nišiu bitovú váhu ako pixel leiaci vpravo od neho v rámci kadej šestice pixelov. Takto organizovanı pamäovı priestor videopamäte umoòuje zobrazi obraz v rozlíšení 288 &times; 256 pixelov. Kadá horizontálna šestica pixelov môe by zobrazená navyše v 4-och módoch:
<br/><br/>

<table border="1" align="center">
	<tr><th>BLINK</td><th>BRIGHTNESS</th><th>zobrazenie</th></tr>
	<tr><td>L</td><td>L</td><td>normálne</td></tr>
	<tr><td>L</td><td>H</td><td>zvıšenı jas</td></tr>
	<tr><td>H</td><td>L</td><td>normálne + blikanie 1 Hz</td></tr>
	<tr><td>H</td><td>H</td><td>zvıšenı jas + blikanie 1 Hz</td></tr>
</table>




</p>
<p>
Najpracnejšou úlohou videoprocesora je serializácia jedného TV mikroriadku, t.j. rozklad 48 bajtov do 288 pixelov spolu s grafickımi atribútmi v reálnom èase. To vyaduje spracova 48 bajtov poèas 48 us, teda zvládnu konverziu 8 Mb/s dát do 6 Mpx/s (megapixelov za sekundu). To znamená pre kadı bajt vysla adresu na adresnú zbernicu, preèíta ho, vysla postupne 6 po sebe idúcich pixelov, inkrementova ukazovate¾e .... Pri pouití procesora ATmega128 taktovaného na 18 MHz by sme museli jeden pixel vygenerova za 3 periódy hodín. Keïe bene dostupnı je procesor beiaci na 16 MHz, bolo nutné urobi kompromis a generova nerovnako široké pixely pod¾a tabu¾ky:

<br/><br/>
<table border="1" align="center">
	<tr><td>P0</td><td>P1</td><td>P2</td><td>P3</td><td>P4</td><td>P5</td><th>= 6 pixelov</th></tr>
	<tr><td>3 clk</td><td>2 clk</td><td>3 clk</td><td>3 clk</td><td>2 clk</td><td>3 clk</td><th align="left">= 16 clk@16 MHz</th></tr>
</table>
<br/>
Dva pixely z kadej šestice sú skrátené na 2/3 šírky normálneho pixelu aby 6 pixelov bolo vygenerovanıch za 16 periód hodín, t.j. za 1 us. Pri takte 18 MHz sú pixely (po rekompilácií programu) rovnako široké. 

<br/><br/>
<table border="1" align="center">
	<tr><td>P0</td><td>P1</td><td>P2</td><td>P3</td><td>P4</td><td>P5</td><th>= 6 pixelov</th></tr>
	<tr><td>3 clk</td><td>3 clk</td><td>3 clk</td><td>3 clk</td><td>3 clk</td><td>3 clk</td><th align="left">= 18 clk@18 MHz</th></tr>
</table>
<br/>


Serializácia videodát spolu s grafickımi atribútmi je moná vïaka špeciálnemu rozloeniu signálov VIDEO_DATA a BRIGHT na porte PORTE, ktoré umoòuje vyui inštrukciu aritmetického posuvu vpravo (ASR). Blikací atribút BLINK je realizovanı èisto softvérovo.

</p>
<h3>Generovanie synchronizaènıch signálov</h3>
<p>
Na vytvorenie úplneho kompozitného videa potrebujeme okrem modulaèného signálu VIDEO_DATA taktie synchronizaènı signál SYNC. Horizontálny synchronizaènı signál s opakovacou frekvenciou 15625 Hz a šírkou impulzu 4.7 us negatívnej polarity je realizovanı PWM modulátorom vyvedenom na pine OC3A. Polohu horizontálneho synchronizaèného impulzu je moné nastavi takmer ¾ubovo¾ne vzh¾adom na zaèiatok generovania TV mikroriadku. V súèasnej verzii sa 6 us po horizontálnom synchronizaènom impulze sa zaèína kresli prvı pixel daného mikroriadku. Za jednu sekundu sa teda zobrazí 15625 mikroriadkov èo tvorí 312 mikroriadkov s opakovacou frekvenciou 50.08 Hz. Je zvolené neprekladané riadkovanie, t.j. susednı párny aj nepárny snímok sú totoné. (Klasická TV norma uvauje o 625 TV riadkoch, ktoré sa prenášajú s opakovacou frekvenciou 25 Hz systémom: najprv párny snímok tvorenı 312.5 riadkami a potom nepárny snímok 312.5 riadkov. 312.5 riadkové snímky sa teda prenášajú frekvenciou 50 Hz.)
</p>

<p>
Z  celkového poètu 312 mikroriadkov sa aktívne zobrazuje 256 riadkov. Zvyšné mikroriadky slúia sú nepouité alebo slúia na prenos snímkovıch (vertikálnych) synchronizaènıch impulzov. Vertikálny synchronizaènı impulz tvorí 5 TV mikroriadkov tvorenıch s predåenım horizontálnym synchronizaènım impulzom na 32 us. Poloha - vertikálne a horizontálne posunutie obrazu je moné zmeni v programe zmenením práve posunutia synchronizácie. Jedná sa o zjednodušené implementovanie TV normy. Konštrukcia bola overená na televízoroch: CTV 2134A.
</p>

<h2>EMULÁCIA PROCESORA 8080</h2>

<p>
Keïe ATmega128 je vyaená generovaním videosignálu, vygenerovanie kadého TV mikrotriadku trvá cca 50 us zo 64 us. Zvyšnı èas spätného chodu lúèa cca 12 us je vyuitı práve na emuláciu správania procesora Intel 8080 a ostanıch obvodov PMDèka. 
</p>


<h2>Download programu z PC</h2>
<p>
Na nahratie (upload) emulaèného programu do pamäte FLASH procesora Atmega128 vyuívame rozhranie SPI vyvedené na konektore JP1 (ISP). Pretoe niektoré signály rozhrania sú pouívané aj rozhraním ku PS/2 klávesnici je bezpodmieneène nutné pred uploadom ju odpoji, pretoe klávesnica by prenos rušila. Poèas uploadu môeme na pripojenom TV sledova horizontálne èiary, indikujúce prebiehajúci prenos.
</p>

</BODY>



</HTML>

